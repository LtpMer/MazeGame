<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LtpMer's Maze Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // If you want to use Analytics, uncomment the line below and ensure 'getAnalytics' is imported above.
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- IMPORTANT: FOR EXTERNAL HOSTING, REPLACE THIS WITH YOUR ACTUAL FIREBASE CONFIG ---
        // You MUST ensure this 'myFirebaseConfig' object contains your OWN Firebase project's configuration.
        // This configuration can be found in your Firebase project settings (web app section).
        // The 'projectId' field is crucial for connecting to your Firestore database.
        
        const myFirebaseConfig = {
          apiKey: "AIzaSyAB3UcTTArjYHrhcDFo780HsK2gIYVGXjQ",
          authDomain: "mazegame-27b3f.firebaseapp.com",
          projectId: "mazegame-27b3f",
          storageBucket: "mazegame-27b3f.firebasestorage.app",
          messagingSenderId: "632041065509",
          appId: "1:632041065509:web:659ed37bf4475df8da83cc",
          measurementId: "G-EFMZ0KCNM5" // Optional: Include if you want Firebase Analytics
        };
        // This line is crucial: it makes your Firebase config globally accessible to the game logic.
        // For Canvas environment, __firebase_config is often provided as a string.
        // We'll prioritize the Canvas-provided __firebase_config if available.
        window.__firebase_config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : myFirebaseConfig;
        
        // --------------------------------------------------------------------------------------

        // Global variables for Firebase (will be populated by the environment or manually)
        // If running outside Canvas, __app_id and __initial_auth_token will be undefined.
        // The game will use the manually provided window.__firebase_config.
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : (window.__firebase_config ? window.__firebase_config.appId : 'default-app-id');
        window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        console.log("Firebase config received:", window.__firebase_config); // Added for debugging
        console.log("App ID received:", window.__app_id); // Added for debugging

        // Initialize Firebase
        if (window.__firebase_config && window.__firebase_config.projectId) { // Added check for projectId
            try {
                window.firebaseApp = initializeApp(window.__firebase_config);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // If you enabled Analytics, uncomment the line below:
                // window.analytics = getAnalytics(window.firebaseApp);

                // Sign in anonymously or with custom token
                if (window.__initial_auth_token) {
                    signInWithCustomToken(window.auth, window.__initial_auth_token)
                        .then(() => {
                            console.log("Firebase signed in with custom token.");
                            window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                            document.dispatchEvent(new Event('firebaseAuthReady'));
                        })
                        .catch((error) => {
                            console.error("Error signing in with custom token:", error);
                            signInAnonymously(window.auth)
                                .then(() => {
                                    console.log("Firebase signed in anonymously.");
                                    window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                                    document.dispatchEvent(new Event('firebaseAuthReady'));
                                })
                                .catch((anonError) => {
                                    console.error("Error signing in anonymously:", anonError);
                                    window.userId = crypto.randomUUID(); // Fallback to random ID
                                    document.dispatchEvent(new Event('firebaseAuthReady'));
                                });
                        });
                } else {
                    signInAnonymously(window.auth)
                        .then(() => {
                            console.log("Firebase signed in anonymously.");
                            window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                            document.dispatchEvent(new Event('firebaseAuthReady'));
                        })
                        .catch((error) => {
                            console.error("Error signing in anonymously:", error);
                            window.userId = crypto.randomUUID(); // Fallback to random ID
                            document.dispatchEvent(new Event('firebaseAuthReady'));
                        });
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Auth state changed, user ID:", window.userId);
                    } else {
                        console.log("Auth state changed, no user.");
                        // If user logs out, userId might need to be re-evaluated or handled
                    }
                });
            } catch (initError) {
                console.error("Error initializing Firebase App:", initError);
                console.warn("Running without Firebase features due to initialization error.");
                window.userId = crypto.randomUUID(); // Generate a random ID if Firebase initialization fails
                document.dispatchEvent(new Event('firebaseAuthReady'));
            }
        } else {
            console.warn("Firebase config not found or projectId missing. Running without Firebase features.");
            window.userId = crypto.randomUUID(); // Generate a random ID if Firebase is not configured
            document.dispatchEvent(new Event('firebaseAuthReady'));
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a202c; /* Dark background */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #e2e8f0; /* Light text */
            position: relative; /* Needed for absolute positioning of info button */
            /* Removed overflow: hidden; to allow scrolling */
        }

        .game-container {
            background-color: #2d3748; /* Slightly lighter dark background for container */
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 90%;
            width: 700px; /* Max width for larger screens */
            gap: 20px;
            position: relative; /* For z-index */
        }

        h1 {
            color: #63b3ed; /* Blue title */
            margin-bottom: 15px;
            font-size: 2.5rem;
            text-align: center;
        }

        canvas {
            background-color: #f0f0f0; /* Light grey maze background for paths */
            border: 5px solid #4a5568; /* Darker border for canvas */
            border-radius: 10px;
            display: block;
            touch-action: none; /* Prevent default touch actions like scrolling/zooming */
            max-width: 100%; /* Ensure canvas is responsive */
            height: auto; /* Maintain aspect ratio */
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .button-row {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center;
            gap: 15px;
            width: 100%;
        }

        button {
            background-color: #48bb78; /* Green button */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex-grow: 1; /* Allow buttons to grow */
            max-width: 200px; /* Adjust max-width for better distribution */
        }

        button:hover {
            background-color: #38a169; /* Darker green on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Specific button styles */
        .start-screen-button { /* For Play, Customization, Menu on start screen */
            background-color: #63b3ed; /* Blue for main buttons */
            font-weight: bold;
            font-size: 1.8rem; /* Larger font for main buttons */
            padding: 20px 40px;
            border-radius: 15px;
            max-width: 300px;
            min-width: 150px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        .start-screen-button:hover {
            background-color: #4299e1;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }
        .start-screen-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #customizationButtonStart, #menuButtonStart, #leaderboardButton { /* Added leaderboard button */
            background-color: #f6ad55; /* Orange for Customization */
            font-size: 1.2rem; /* Smaller than Play, larger than game controls */
            padding: 15px 30px;
            max-width: 250px;
        }
        #customizationButtonStart:hover, #menuButtonStart:hover, #leaderboardButton:hover {
            background-color: #ed8936;
        }

        #menuButtonStart {
            background-color: #a0aec0; /* Grey for Menu */
        }
        #menuButtonStart:hover {
            background-color: #718096;
        }

        /* Daily Level Display */
        .daily-level-container {
            background-color: #4a5568; /* Darker grey for daily level box */
            border-radius: 10px;
            padding: 15px 20px;
            margin-top: 20px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .daily-level-container h3 {
            color: #63b3ed;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        .daily-level-container p {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        .daily-level-container button {
            background-color: #4CAF50;
            font-size: 1.1rem;
            padding: 10px 20px;
            max-width: 250px;
        }
        .daily-level-container button:hover {
            background-color: #388E3C;
        }


        /* Touch controls for mobile */
        .touch-controls {
            display: none; /* Hidden by default, shown on smaller screens */
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            gap: 10px;
            margin-top: 20px;
            width: 200px;
            height: 200px;
            justify-items: center;
            align-items: center;
        }

        .touch-button {
            background-color: #63b3ed; /* Blue for touch buttons */
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .touch-button:active {
            background-color: #4299e1;
            transform: scale(0.95);
        }

        .touch-button.up { grid-area: up; }
        .touch-button.down { grid-area: down; }
        .touch-button.left { grid-area: left; }
        .touch-button.right { grid-area: right; }

        /* Info and Login Buttons in corner */
        .corner-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        .corner-buttons button {
            background-color: #f6ad55; /* Orange color */
            color: #2d3748;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: none;
            min-width: unset;
            text-align: center;
            flex-grow: 0; /* Prevent them from growing */
            max-width: unset; /* Remove max-width constraint */
        }

        .corner-buttons button:hover {
            background-color: #ed8936;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .corner-buttons button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #loginButton.logged-in {
            background-color: #e53e3e; /* Red for logout */
        }
        #loginButton.logged-in:hover {
            background-color: #c53030;
        }


        /* General Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100; /* Ensure it's on top of everything */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #2d3748;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            color: #e2e8f0;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h2 {
            color: #63b3ed;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .modal-content .close-button {
            background-color: #e53e3e; /* Red close button */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
        }

        .modal-content .close-button:hover {
            background-color: #c53030;
            transform: translateY(-1px);
        }

        /* Game State Specific Displays */
        .start-screen, .game-play-area, .build-mode-area {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            justify-content: center;
            gap: 20px;
        }

        .start-screen.active, .game-play-area.active, .build-mode-area.active {
            display: flex; /* Shown when active */
        }

        /* Styles for buttons inside menu modal */
        .menu-modal-buttons button {
            background-color: #4CAF50; /* Green for menu options */
            margin-bottom: 10px;
            max-width: 300px;
        }
        .menu-modal-buttons button:hover {
            background-color: #388E3C;
        }
        #clearBuildGridButton {
            background-color: #e53e3e; /* Red for clear button */
        }
        #clearBuildGridButton:hover {
            background-color: #c53030;
        }

        /* Build Mode Tool Buttons */
        .build-tools {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
            width: 100%;
        }
        .build-tools button {
            background-color: #63b3ed; /* Blue for tools */
            flex-grow: 0;
            max-width: 120px;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        .build-tools button.active-tool {
            background-color: #4299e1;
            box-shadow: 0 0 0 3px #4299e1, 0 0 0 6px #63b3ed; /* Highlight active tool */
        }
        #saveLevelButton, #publishLevelButton { /* Added publish button */
            background-color: #4CAF50; /* Green for save */
            font-weight: bold;
            font-size: 1.1rem;
            padding: 10px 20px;
        }
        #saveLevelButton:hover, #publishLevelButton:hover {
            background-color: #388E3C;
        }

        /* Customization Modal Styles */
        .customization-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .customization-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .customization-option label {
            flex-basis: 40%;
            text-align: left;
            font-size: 1.1rem;
        }
        .customization-option input[type="color"] {
            flex-basis: 55%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .customization-option input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .customization-option input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 8px;
        }
        .customization-option input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 8一層;
        }

        /* Level Lists (My Levels & Community Levels) */
        .level-list-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            width: 100%;
            text-align: left;
        }
        .level-list-container div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #4a5568;
        }
        .level-list-container div:last-child {
            border-bottom: none;
        }
        .level-list-container button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.9rem;
            max-width: 80px;
            flex-shrink: 0;
        }
        .level-list-container .level-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .level-list-container .play-level-button {
            background-color: #68d391;
        }
        .level-list-container .play-level-button:hover {
            background-color: #48bb78;
        }
        .level-list-container .delete-level-button {
            background-color: #e53e3e;
        }
        .level-list-container .delete-level-button:hover {
            background-color: #c53030;
        }
        .level-list-container .set-daily-button { /* New style for admin button */
            background-color: #FFD700; /* Gold */
            color: #2d3748;
        }
        .level-list-container .set-daily-button:hover {
            background-color: #DAA520; /* Darker Gold */
        }
        /* New style for "Set as Official" button */
        .level-list-container .set-official-button {
            background-color: #805AD5; /* Purple */
            color: white;
        }
        .level-list-container .set-official-button:hover {
            background-color: #6B46C1;
        }

        /* Leaderboard Specific Styles */
        .leaderboard-list-container {
            max-height: 300px; /* Make it scrollable */
            overflow-y: auto;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            width: 100%;
            text-align: left;
        }
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #4a5568;
        }
        .leaderboard-entry:last-child {
            border-bottom: none;
        }
        .leaderboard-entry .rank {
            font-weight: bold;
            color: #63b3ed;
            width: 30px;
            flex-shrink: 0;
        }
        .leaderboard-entry .player-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }
        .leaderboard-entry .level-name-lb {
            font-size: 0.9em;
            color: #a0aec0;
            margin-right: 10px;
        }
        .leaderboard-entry .time {
            font-weight: bold;
            color: #4CAF50;
            flex-shrink: 0;
        }

        /* Login Modal specific styles */
        .login-form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .login-form-group label {
            display: block;
            margin-bottom: 5px;
            color: #e2e8f0;
        }
        .login-form-group input {
            width: calc(100% - 20px);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            color: #e2e8f0;
            font-size: 1rem;
        }
        .login-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .login-buttons button {
            flex-grow: 1;
            max-width: 150px;
        }
        .login-buttons #loginSubmitButton {
            background-color: #63b3ed;
        }
        .login-buttons #loginSubmitButton:hover {
            background-color: #4299e1;
        }
        .login-buttons #loginCancelButton {
            background-color: #a0aec0;
        }
        .login-buttons #loginCancelButton:hover {
            background-color: #718096;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            .game-container {
                padding: 20px;
                width: 100%;
            }
            .message-box {
                font-size: 1rem;
                padding: 10px 15px;
            }
            button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            .touch-controls {
                display: grid; /* Show touch controls on small screens */
            }
            .corner-buttons {
                top: 10px;
                right: 10px;
                gap: 5px;
            }
            .corner-buttons button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-content h2 {
                font-size: 1.7rem;
            }
            .modal-content p {
                font-size: 1rem;
            }
            .button-row {
                flex-direction: column; /* Stack buttons vertically on small screens */
            }
            button {
                max-width: 100%; /* Full width for stacked buttons */
            }
            .start-screen-button {
                font-size: 1.5rem;
                padding: 15px 30px;
            }
            #customizationButtonStart, #menuButtonStart, #leaderboardButton {
                font-size: 1.1rem;
                padding: 12px 25px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Start Screen -->
        <div id="startScreen" class="start-screen">
            <h1>LtpMer's Maze Game</h1>
            <button id="playButton" class="start-screen-button">Play</button>
            <button id="customizationButtonStart" class="start-screen-button">Customization</button>
            <button id="menuButtonStart" class="start-screen-button">Menu</button>
            <button id="leaderboardButton" class="start-screen-button">Leaderboard</button> <!-- New Leaderboard Button -->

            <div id="dailyLevelContainer" class="daily-level-container" style="display: none;">
                <h3>Daily Level</h3>
                <p id="dailyLevelName">Loading daily level...</p>
                <button id="playDailyLevelButton">Play Daily Level</button>
            </div>
        </div>

        <!-- Game Play Area (for levels, random maze, random blocks) -->
        <div id="gamePlayArea" class="game-play-area">
            <canvas id="mazeCanvas"></canvas>
            <div class="message-box" id="messageBox">Use arrow keys or WASD to move!</div>
            <div class="controls">
                <div class="button-row">
                    <button id="nextLevelButton" style="display: none;">Next Level</button> <!-- Only for Level Mode -->
                    <button id="backToMainMenuButtonGame">Back to Main Menu</button>
                </div>
                <div class="touch-controls">
                    <button class="touch-button up" data-direction="up">&#9650;</button>
                    <button class="touch-button left" data-direction="left">&#9664;</button>
                    <button class="touch-button right" data-direction="right">&#9654;</button>
                    <button class="touch-button down" data-direction="down">&#9660;</button>
                </div>
            </div>
        </div>

        <!-- Build Mode Area -->
        <div id="bu
